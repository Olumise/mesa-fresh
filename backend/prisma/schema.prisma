// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String            @id @default(uuid())
  name           String
  email          String
  image          String?
  phone          String
  emailVerified  Boolean           @default(false) @map("email_verified")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  roleId         String
  role           DBRole            @relation(fields: [roleId], references: [id])
  sessions       Session[]
  accounts       Account[]
  staffs         Staff[]
  invitations    StaffInvitation[]
  customer_orders Order[]

  @@unique([email])
  @@map("users")
}

model DBRole {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  users       User[]

  @@unique([name])
  @@map("db_roles")
}

model StaffInvitation {
  id              String    @id @default(uuid())
  invited_by      String
  inviter         User      @relation(fields: [invited_by], references: [id])
  invited_email   String    @unique
  invitation_code String    @unique
  is_accepted     Boolean   @default(false)
  accepted_at     DateTime?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  staff           Staff?
  location_id     String
  location        Location  @relation(fields: [location_id], references: [id])

  @@map("staff_invitation")
}

model Staff {
  id                   String               @id @default(uuid())
  user_id              String               @unique
  user                 User                 @relation(fields: [user_id], references: [id])
  location_id          String
  location             Location             @relation(fields: [location_id], references: [id])
  date_joined          DateTime
  date_left            DateTime?
  is_active            Boolean
  role_id              String
  role                 StaffRole            @relation(fields: [role_id], references: [id])
  invitation_id        String               @unique
  invitation           StaffInvitation      @relation(fields: [invitation_id], references: [id])
  managers             Manager[]
  orders_created       Order[]              @relation("OrderCreatedBy")
  payments_processed   Payment[]
  order_status_changes OrderStatusHistory[]
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")

  @@unique([user_id, location_id])
  @@map("staffs")
}

model StaffRole {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  staff       Staff[]

  @@unique(name)
  @@map("staff_roles")
}

model Location {
  id                  String               @id @default(uuid())
  name                String
  address             String
  staffs              Staff[]
  square_ft           String
  sitting_capacity    Int
  open_date           DateTime
  is_active           Boolean
  managers            Manager[]
  location_menus      LocationMenu[]
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  staffInvitations    StaffInvitation[]
  locationIngredients LocationIngredient[]
  orders              Order[]

  @@unique(name)
  @@map("locations")
}

model Manager {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  staff_id    String
  staff       Staff    @relation(fields: [staff_id], references: [id])
  location_id String
  location    Location @relation(fields: [location_id], references: [id])

  @@unique([staff_id, location_id])
  @@map("managers")
}

model Menu {
  id               String           @id @default(uuid())
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  name             String           @unique
  price            Decimal          @db.Decimal(10, 2)
  description      String
  image            String
  category_id      String
  category         MenuCategory     @relation(fields: [category_id], references: [id])
  calories         Int
  prep_time        String
  is_customizable  Boolean
  location_menus   LocationMenu[]
  menu_addons      MenuAddon[]
  menu_ingredients MenuIngredient[]
  order_items      OrderItem[]

  @@map("menus")
}

model Addon {
  id                 String             @id @default(uuid())
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  name               String             @unique
  price              Decimal            @default(0.0)
  is_free            Boolean
  menu_addons        MenuAddon[]
  addon_ingredients  AddonIngredient[]
  order_item_addons  OrderItemAddon[]

  @@map("addons")
}

model MenuAddon {
  menu_id   String
  menu      Menu     @relation(fields: [menu_id], references: [id])
  addon_id  String
  addon     Addon    @relation(fields: [addon_id], references: [id])
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@id([menu_id, addon_id])
  @@map("menu_addons")
}

model LocationMenu {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  location_id  String
  location     Location @relation(fields: [location_id], references: [id])
  menu_id      String
  menu         Menu     @relation(fields: [menu_id], references: [id])
  is_available Boolean
  quantity     Int

  @@unique([location_id, menu_id])
  @@map("location_menus")
}

model MenuCategory {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  name        String   @unique
  description String?
  menus       Menu[]

  @@map("menu_categories")
}

model Ingredient {
  id                             String                 @id @default(uuid())
  createdAt                      DateTime               @default(now()) @map("created_at")
  updatedAt                      DateTime               @updatedAt @map("updated_at")
  name                           String                 @unique
  description                    String?
  tracking_type                  IngredientTrackingType @default(PRECISE)
  estimated_usage_per_100_orders Int?
  location_ingredients           LocationIngredient[]
  menu_ingredients               MenuIngredient[]
  addon_ingredients               AddonIngredient[]

  @@map("ingredients")
}

model MenuIngredient {
  menu_id       String
  menu          Menu           @relation(fields: [menu_id], references: [id])
  ingredient_id String
  ingredient    Ingredient     @relation(fields: [ingredient_id], references: [id])
  quantity      Int
  unit          IngredientUnit

  @@id([menu_id, ingredient_id])
  @@map("menu_ingredient")
}

model AddonIngredient {
  addon_id      String
  addon         Addon          @relation(fields: [addon_id], references: [id])
  ingredient_id String
  ingredient    Ingredient     @relation(fields: [ingredient_id], references: [id])
  quantity      Int
  unit          IngredientUnit

  @@id([addon_id, ingredient_id])
  @@map("addon_ingredients")
}

model LocationIngredient {
  location_id   String
  location      Location       @relation(fields: [location_id], references: [id])
  ingredient_id String
  ingredient    Ingredient     @relation(fields: [ingredient_id], references: [id])
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  quantity      Int
  unit          IngredientUnit

  @@id([location_id, ingredient_id])
  @@map("location_ingredients")
}

model Session {
  id        String   @id @default(uuid())
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([identifier])
  @@map("verification")
}

enum IngredientUnit {
  GRAM       @map("gram")
  KILOGRAM   @map("kilogram")
  MILLILITER @map("milliliter")
  LITER      @map("liter")
  PIECE      @map("piece")
  SLICE      @map("slice")
  CLOVE      @map("clove")
  LEAF       @map("leaf")
}

enum IngredientTrackingType {
  PRECISE
  ESTIMATED
}

enum OrderStatus {
  PENDING    @map("pending")
  PREPARING  @map("preparing")
  READY      @map("ready")
  COMPLETED  @map("completed")
  CANCELLED  @map("cancelled")
}

enum PaymentMethod {
  POS      @map("pos")
  TRANSFER @map("transfer")
  CASH     @map("cash")
}

enum PaymentStatus {
  PENDING   @map("pending")
  COMPLETED @map("completed")
  FAILED    @map("failed")
  REFUNDED  @map("refunded")
}

model Order {
  id            String               @id @default(uuid())
  order_number  String               @unique
  location_id   String
  location      Location             @relation(fields: [location_id], references: [id])
  customer_id   String?
  customer      User?                @relation(fields: [customer_id], references: [id])
  customer_name String?
  created_by_id String
  created_by    Staff                @relation("OrderCreatedBy", fields: [created_by_id], references: [id])
  status        OrderStatus          @default(PENDING)
  subtotal      Decimal              @db.Decimal(10, 2)
  tax           Decimal              @default(0.0) @db.Decimal(10, 2)
  total         Decimal              @db.Decimal(10, 2)
  notes         String?
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  completed_at  DateTime?
  cancelled_at  DateTime?
  order_items   OrderItem[]
  payment       Payment?
  status_history OrderStatusHistory[]

  @@index([location_id])
  @@index([customer_id])
  @@index([created_by_id])
  @@index([order_number])
  @@map("orders")
}

model OrderItem {
  id               String           @id @default(uuid())
  order_id         String
  order            Order            @relation(fields: [order_id], references: [id], onDelete: Cascade)
  menu_id          String
  menu             Menu             @relation(fields: [menu_id], references: [id])
  quantity         Int
  unit_price       Decimal          @db.Decimal(10, 2)
  subtotal         Decimal          @db.Decimal(10, 2)
  special_notes    String?
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  order_item_addons OrderItemAddon[]

  @@index([order_id])
  @@index([menu_id])
  @@map("order_items")
}

model OrderItemAddon {
  id            String    @id @default(uuid())
  order_item_id String
  order_item    OrderItem @relation(fields: [order_item_id], references: [id], onDelete: Cascade)
  addon_id      String
  addon         Addon     @relation(fields: [addon_id], references: [id])
  quantity      Int       @default(1)
  unit_price    Decimal   @db.Decimal(10, 2)
  subtotal      Decimal   @db.Decimal(10, 2)
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([order_item_id])
  @@index([addon_id])
  @@map("order_item_addons")
}

model Payment {
  id              String        @id @default(uuid())
  order_id        String        @unique
  order           Order         @relation(fields: [order_id], references: [id], onDelete: Cascade)
  amount          Decimal       @db.Decimal(10, 2)
  payment_method  PaymentMethod
  payment_status  PaymentStatus @default(PENDING)
  transaction_ref String?
  processed_by_id String
  processed_by    Staff         @relation(fields: [processed_by_id], references: [id])
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  completed_at    DateTime?

  @@index([order_id])
  @@index([processed_by_id])
  @@map("payments")
}

model OrderStatusHistory {
  id            String       @id @default(uuid())
  order_id      String
  order         Order        @relation(fields: [order_id], references: [id], onDelete: Cascade)
  from_status   OrderStatus?
  to_status     OrderStatus
  changed_by_id String
  changed_by    Staff        @relation(fields: [changed_by_id], references: [id])
  notes         String?
  createdAt     DateTime     @default(now()) @map("created_at")

  @@index([order_id])
  @@map("order_status_history")
}
